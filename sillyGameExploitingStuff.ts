//% color="#b522cf" icon="\uf126" block="Silly Exploits"
namespace sillyGameExploitingStuff {

    // --- CORRUPTORS ---

    //% block="destroy all sprites with images" group="Corruptors"
    export function corruptAllSprites() {
        let errorImg = image.create(4, 4)
        errorImg.fill(12)
        errorImg.setPixel(0, 0, 15)
        for (let s of sprites.allOfKind(-1)) {
            let newImg = image.create(s.width, s.height)
            for (let x = 0; x <= s.width; x += 4) {
                for (let y = 0; y <= s.height; y += 4) {
                    newImg.drawImage(errorImg, x, y)
                }
            }
            s.setImage(newImg)
        }
    }

    //% block="set tilemap corruption $on" group="Corruptors" //% on.shadow="toggleOnOff"
    export function destroyTileMap(on: boolean) {
        if (on) {
            let errorTile = image.create(16, 16)
            errorTile.fill(12)
            errorTile.fillRect(0, 0, 8, 8, 15)
            errorTile.fillRect(8, 8, 8, 8, 15)
            for (let col = 0; col < 20; col++) {
                for (let row = 0; row < 15; row++) {
                    let loc = tiles.getTileLocation(col, row)
                    let img = tiles.getTileImage(loc)
                    if (img) img.drawImage(errorTile, 0, 0)
                }
            }
        }
    }

    // --- MOVEMENT (Corrected to use target) ---

    //% block="invert controls for $target $on" group="Movement" 
    //% target.shadow="variables_get" on.shadow="toggleOnOff"
    export function invertControls(target: Sprite, on: boolean) {
        if (on) controller.moveSprite(target, -100, -100)
        else controller.moveSprite(target, 100, 100)
    }

    //% block="drunk walking $target" group="Movement" //% target.shadow="variables_get"
    export function drunkWalk(target: Sprite) {
        game.onUpdateInterval(500, function () { target.vx += Math.randomRange(-50, 50) })
    }

    //% block="moonwalk $target" group="Movement" //% target.shadow="variables_get"
    export function moonwalk(target: Sprite) {
        game.onUpdate(function () { if (target.vx > 0) target.image.flipX() })
    }

    //% block="jump turns $target invisible" group="Movement" //% target.shadow="variables_get"
    export function jumpInvis(target: Sprite) {
        controller.A.onEvent(ControllerButtonEvent.Pressed, function () {
            target.setFlag(SpriteFlag.Invisible, true); pause(500); target.setFlag(SpriteFlag.Invisible, false)
        })
    }

    // --- VISUALS ---

    //% block="spin $target" group="Visuals" //% target.shadow="variables_get"
    export function spinSprite(target: Sprite) {
        game.onUpdate(function () { target.setImage(target.image.rotated(90)) })
    }

    //% block="vibrate $target" group="Visuals" //% target.shadow="variables_get"
    export function vibrate(target: Sprite) {
        game.onUpdateInterval(50, function () { target.x += Math.randomRange(-2, 2); target.y += Math.randomRange(-2, 2) })
    }

    //% block="disco background" group="Visuals"
    export function disco() {
        game.onUpdateInterval(200, function () { scene.setBackgroundColor(Math.randomRange(1, 15)) })
    }

    // --- BREAKERS ---

    //% block="fake win" group="Breakers"
    export function fakeWin() {
        game.setGameOverMessage(true, "YOU WIN!"); pause(1500); game.showLongText("SYKE!", DialogLayout.Center)
    }

    //% block="lag game $on" group="Breakers" //% on.shadow="toggleOnOff"
    export function lag(on: boolean) {
        game.onUpdate(function () { if (on) pause(100) })
    }

    //% block="invisible walls" group="Breakers"
    export function invisWalls() {
        for (let x = 0; x < 20; x++) {
            for (let y = 0; y < 15; y++) {
                let loc = tiles.getTileLocation(x, y)
                if (tiles.tileAtLocationIsWall(loc)) tiles.setTileAt(loc, assets.tile`transparency16`)
            }
        }
    }

    // --- CHAOS ---

    //% block="everybody follow $target" group="Chaos" //% target.shadow="variables_get"
    export function follow(target: Sprite) {
        for (let s of sprites.allOfKind(-1)) s.follow(target, 50)
    }

    //% block="projectile storm" group="Chaos"
    export function storm() {
        game.onUpdateInterval(100, function () { sprites.createProjectileFromSide(img`2`, Math.randomRange(-50, 50), 50) })
    }

    //% block="flip gravity $target" group="Chaos" //% target.shadow="variables_get"
    export function flip(target: Sprite) {
        controller.B.onEvent(ControllerButtonEvent.Pressed, function () { target.ay *= -1 })
    }

    //% block="random beeps" group="Chaos"
    export function beeps() {
        game.onUpdateInterval(2000, function () { music.playTone(Math.randomRange(200, 2000), 100) })
    }
}